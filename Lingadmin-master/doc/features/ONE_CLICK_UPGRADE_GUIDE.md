# LingCDN 一键升级功能使用说明

## 功能概述

全新的一键升级功能提供了可视化的系统升级界面，用户可以方便地查看新版本信息、更新内容，并通过一键点击完成系统升级。

## 功能特性

### ✅ 核心功能

1. **自动检查更新** - 页面打开时自动检查是否有新版本
2. **显示更新内容** - 清晰展示新版本的变更日志和描述
3. **一键升级** - 点击按钮即可启动升级过程
4. **实时进度显示** - 升级过程中实时显示进度和状态
5. **升级历史记录** - 查看历史升级记录
6. **断点续传** - 支持下载中断后继续（集成之前的优化）
7. **自动重启** - 升级完成后自动重启服务

### 📊 界面展示

#### 1. 无更新状态
```
┌─────────────────────────────────────┐
│ 系统升级                            │
├─────────────────────────────────────┤
│ ✓ 当前已是最新版本                  │
│   当前版本：1.0.7                   │
│   检查时间：2025-10-31 14:30:00    │
│                                     │
│ [检查更新] [升级历史]               │
└─────────────────────────────────────┘
```

#### 2. 发现新版本
```
┌─────────────────────────────────────┐
│ 系统升级                            │
├─────────────────────────────────────┤
│ ℹ️ 发现新版本                        │
│   当前版本：1.0.7                   │
│   最新版本：1.0.8                   │
│   检查时间：2025-10-31 14:30:00    │
│                                     │
│ 更新内容                            │
│ ┌─────────────────────────────────┐ │
│ │ 新增功能：                       │ │
│ │ - 添加一键升级功能               │ │
│ │ - 支持断点续传                   │ │
│ │ - 实时进度显示                   │ │
│ │                                  │ │
│ │ 变更日志：                       │ │
│ │ - 修复若干 bug                   │ │
│ │ - 性能优化                       │ │
│ └─────────────────────────────────┘ │
│                                     │
│ [一键更新到 1.0.8]                  │
│                                     │
│ [检查更新] [升级历史]               │
└─────────────────────────────────────┘
```

#### 3. 升级中
```
┌─────────────────────────────────────┐
│ 系统升级                            │
├─────────────────────────────────────┤
│ 🔄 正在升级...                       │
│                                     │
│ [████████░░░░░░░░░░] 65%           │
│ 下载中...                           │
│                                     │
│ 当前版本：1.0.7                     │
│ 目标版本：1.0.8                     │
│ 下载速度：5.23 MB/s                 │
│ 开始时间：2025-10-31 14:31:00      │
└─────────────────────────────────────┘
```

## 文件清单

### 后端文件

```
/root/Lingadmin-master/internal/web/actions/default/settings/upgrade/
├── init.go         - 路由配置（已更新）
├── index.go        - 升级页面（已更新）
├── check.go        - 检查更新 API（新建）
├── install.go      - 执行升级 API（新建）
├── progress.go     - 获取进度 API（新建）
└── history.go      - 升级历史 API（新建）
```

### 前端文件

```
/root/Lingadmin-master/web/views/@default/settings/upgrade/
├── index.html      - 升级页面 HTML（已更新）
└── index.js        - 前端逻辑（新建）
```

## API 接口

### 1. 检查更新
```
POST /settings/upgrade/check
```

**响应示例**:
```json
{
  "code": 200,
  "message": "ok",
  "data": {
    "hasUpdate": true,
    "updateInfo": {
      "version": "1.0.8",
      "currentVersion": "1.0.7",
      "changelog": "- 新增一键升级功能\n- 支持断点续传\n- 实时进度显示",
      "description": "本次更新主要增强了升级体验",
      "checkTime": "2025-10-31 14:30:00",
      "downloadURL": "http://dl.lingcdn.cloud/ling-admin-v1.0.8-linux-amd64.tar.gz"
    }
  }
}
```

### 2. 执行升级
```
POST /settings/upgrade/install
```

**响应示例**:
```json
{
  "code": 200,
  "message": "更新任务已启动，系统将在后台下载并安装新版本",
  "data": {}
}
```

### 3. 获取进度
```
POST /settings/upgrade/progress
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "status": "downloading",
    "progress": {
      "oldVersion": "1.0.7",
      "newVersion": "1.0.8",
      "status": "downloading",
      "startTime": "2025-10-31 14:31:00",
      "downloadSpeed": 5.23,
      "downloadSize": 14586227
    }
  }
}
```

### 4. 升级历史
```
POST /settings/upgrade/history
参数: { "limit": 10 }
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "history": [
      {
        "id": "20251031143100-abc123",
        "oldVersion": "1.0.6",
        "newVersion": "1.0.7",
        "status": "success",
        "startTime": "2025-10-30 10:00:00",
        "endTime": "2025-10-30 10:03:25",
        "duration": 205,
        "downloadSpeed": 6.12
      }
    ]
  }
}
```

## 升级流程

### 用户操作流程

1. **访问升级页面**
   - 登录管理后台
   - 进入 `设置` → `系统升级`

2. **检查更新**
   - 页面自动检查更新
   - 或点击 `检查更新` 按钮手动检查

3. **查看更新内容**
   - 如果有新版本，会显示：
     - 当前版本号
     - 新版本号
     - 更新描述
     - 变更日志

4. **执行升级**
   - 点击 `一键更新到 x.x.x` 按钮
   - 确认升级对话框
   - 系统开始下载和安装

5. **监控进度**
   - 实时显示进度条（0-100%）
   - 显示当前状态（下载中、验证中、安装中）
   - 显示下载速度和已用时间

6. **完成升级**
   - 升级成功后显示完成消息
   - 5秒后自动刷新页面
   - 系统已升级到新版本

### 后台执行流程

```
1. 用户点击升级按钮
   ↓
2. 发送 /install 请求
   ↓
3. 后台启动 goroutine 执行升级
   ↓
4. 前端每秒轮询 /progress 获取进度
   ↓
5. 后台执行：
   - pending: 准备中 (5%)
   - downloading: 下载文件 (30%)
     * 支持断点续传
     * 记录下载速度
   - verifying: 验证 SHA256 (70%)
   - installing: 安装文件 (85%)
     * 备份旧版本
     * 替换二进制文件
     * 更新 web 目录
   - success: 完成 (100%)
     * 记录日志
     * 重启服务
   ↓
6. 前端检测到 success 状态
   ↓
7. 显示完成消息，5秒后刷新
   ↓
8. 系统自动重启，升级完成
```

## 状态说明

| 状态 | 说明 | 进度 |
|-----|------|------|
| idle | 空闲状态 | 0% |
| pending | 准备中 | 5% |
| downloading | 下载中 | 30% |
| verifying | 验证文件 | 70% |
| installing | 安装中 | 85% |
| success | 升级成功 | 100% |
| failed | 升级失败 | 0% |
| cancelled | 已取消 | 0% |

## 使用示例

### 场景 1：正常升级

```
1. 访问升级页面
   → 自动检查更新
   → 发现新版本 1.0.8

2. 查看更新内容
   → 阅读变更日志
   → 了解新功能

3. 点击"一键更新到 1.0.8"
   → 确认对话框：确定
   → 开始下载（30%）

4. 下载完成
   → 验证文件（70%）
   → 安装文件（85%）

5. 升级完成（100%）
   → 显示成功消息
   → 5秒后自动刷新
   → 系统已是 1.0.8
```

### 场景 2：网络中断续传

```
1. 开始下载 1.0.8
   → 下载到 60%
   → 网络中断

2. 自动记录断点
   → 保存已下载的 60%

3. 网络恢复
   → 自动从 60% 继续
   → 无需重新下载前 60%

4. 完成剩余 40%
   → 继续验证和安装
   → 升级成功
```

### 场景 3：升级失败

```
1. 开始升级
   → 下载完成
   → SHA256 验证失败

2. 显示错误信息
   → 状态：failed
   → 错误：sha256 mismatch
   → 记录到升级历史

3. 用户可以：
   → 重新检查更新
   → 再次尝试升级
   → 查看升级历史了解详情
```

## 查看升级历史

点击 `升级历史` 按钮，会弹出对话框显示历史记录：

| 开始时间 | 版本 | 状态 | 耗时 | 下载速度 |
|---------|------|------|------|---------|
| 2025-10-31 14:31:00 | 1.0.7 → 1.0.8 | 成功 | 3 分 25 秒 | 5.23 MB/s |
| 2025-10-30 10:00:00 | 1.0.6 → 1.0.7 | 成功 | 2 分 18 秒 | 6.12 MB/s |
| 2025-10-29 15:20:00 | 1.0.5 → 1.0.6 | 失败 | 1 分 5 秒 | 4.56 MB/s |

## 注意事项

### ⚠️ 升级前

1. **备份数据** - 虽然系统会自动备份，但建议手动备份重要数据
2. **检查磁盘空间** - 确保有足够的磁盘空间（至少 500MB）
3. **稳定网络** - 虽然支持断点续传，但稳定的网络能加快升级
4. **避免高峰期** - 在业务低峰期执行升级

### ⚠️ 升级中

1. **不要关闭页面** - 页面会实时显示进度，关闭不影响后台升级
2. **不要重复点击** - 一次只能执行一个升级任务
3. **不要重启服务器** - 等待升级完成后自动重启

### ⚠️ 升级后

1. **验证功能** - 升级完成后测试关键功能
2. **检查日志** - 查看是否有错误日志
3. **回滚准备** - 如果有问题，可以使用备份文件回滚

## 故障排除

### 问题 1：检查更新失败

**原因**:
- 网络连接问题
- 更新服务器不可用

**解决方案**:
```bash
# 检查网络连接
ping dl.lingcdn.cloud

# 手动检查更新 API
curl http://dl.lingcdn.cloud/api/boot/versions
```

### 问题 2：下载失败

**原因**:
- 磁盘空间不足
- 网络不稳定

**解决方案**:
```bash
# 检查磁盘空间
df -h /tmp

# 清理临时文件
rm -rf /tmp/ling-*.tar.gz
rm -rf /tmp/edge-*-tmp
```

### 问题 3：安装失败

**原因**:
- 权限不足
- 文件被占用

**解决方案**:
```bash
# 检查进程
ps aux | grep ling-admin

# 检查权限
ls -l /opt/lingcdn/bin/

# 手动停止服务
systemctl stop ling-admin
```

### 问题 4：升级后无法访问

**原因**:
- 服务未启动
- 配置文件问题

**解决方案**:
```bash
# 检查服务状态
systemctl status ling-admin

# 查看日志
journalctl -u ling-admin -n 50

# 手动启动服务
systemctl start ling-admin

# 如果需要回滚
cd /opt/lingcdn/bin
mv ling-admin ling-admin.new
mv ling-admin.backup.1.0.7 ling-admin
systemctl restart ling-admin
```

## 技术细节

### 集成的优化功能

1. **断点续传** - 来自 `upgrade_manager_v2.go`
2. **错误分类** - 来自 `upgrade_errors.go`
3. **升级日志** - 来自 `upgrade_logger.go`
4. **状态通知** - 来自 `upgrade_notifier.go`
5. **文件清理** - 来自 `temp_file_cleaner.go`

### 前端技术栈

- Vue.js（框架）
- Semantic UI（UI 组件）
- jQuery（工具库）
- Ajax 轮询（实时更新）

### 后端技术栈

- Go 1.18+
- TeaGo（Web 框架）
- SHA-256（文件验证）
- Systemd（服务管理）

## 性能指标

| 指标 | 数值 |
|-----|-----|
| 页面加载时间 | < 1 秒 |
| 检查更新耗时 | < 3 秒 |
| 进度更新频率 | 每秒 1 次 |
| 下载速度 | 取决于网络（通常 5-10 MB/s） |
| 完整升级耗时 | 2-5 分钟 |

## 安全性

1. **权限控制** - 需要管理员登录
2. **CSRF 保护** - 所有 POST 请求带 CSRF Token
3. **文件校验** - SHA-256 验证确保文件完整性
4. **备份机制** - 自动备份旧版本
5. **审计日志** - 记录所有升级操作

## 未来改进

- [ ] 支持手动回滚功能
- [ ] 添加邮件通知
- [ ] 支持灰度升级
- [ ] 添加升级前检查
- [ ] WebSocket 实时推送（替代轮询）
- [ ] 支持离线升级包
- [ ] 多语言支持

## 总结

全新的一键升级功能为 LingCDN 提供了：

✅ **简单易用** - 一键点击完成升级
✅ **可视化** - 实时查看升级进度
✅ **安全可靠** - 自动备份，SHA-256 验证
✅ **智能续传** - 网络中断自动继续
✅ **历史追溯** - 完整的升级记录
✅ **用户友好** - 清晰的状态提示

用户只需访问升级页面，点击一键升级按钮，即可完成整个升级过程！

---

**创建日期**: 2025-10-31
**版本**: 1.0
**作者**: Claude Code
