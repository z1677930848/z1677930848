name: Release

on:
  push:
    tags:
      - 'v*'  # 匹配 v1.0.0, v1.1.6 等

env:
  GO_VERSION: '1.21'
  # 下载站地址
  DL_SERVER_URL: 'http://dl.lingcdn.cloud'

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y zip unzip

      - name: Install cross-compile toolchain
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Build EdgeCommon
        working-directory: EdgeCommon
        run: go mod tidy

      - name: Build Lingnode
        working-directory: Lingnode-master/build
        run: |
          chmod +x build.sh
          ./build.sh linux ${{ matrix.arch }} community

      - name: Build Lingapi
        working-directory: Lingapi-master/build
        env:
          EDGENODE_PATH: ${{ github.workspace }}/Lingnode-master
        run: |
          chmod +x build.sh
          ./build.sh linux ${{ matrix.arch }} community

      - name: Build Lingadmin
        working-directory: Lingadmin-master/build
        env:
          EDGEAPI_PATH: ${{ github.workspace }}/Lingapi-master
        run: |
          chmod +x build.sh
          ./build.sh linux ${{ matrix.arch }} community

      - name: List built artifacts
        run: |
          echo "=== Lingnode ==="
          ls -la Lingnode-master/dist/ || true
          echo "=== Lingapi ==="
          ls -la Lingapi-master/dist/ || true
          echo "=== Lingadmin ==="
          ls -la Lingadmin-master/dist/ || true

      - name: Rename artifacts for upload
        id: rename
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          ARCH=${{ matrix.arch }}

          # 创建统一的输出目录
          mkdir -p dist

          # Lingnode - 重命名为标准格式
          if ls Lingnode-master/dist/*.zip 1> /dev/null 2>&1; then
            NODE_FILE=$(ls Lingnode-master/dist/*.zip | head -1)
            NODE_NEW="dist/ling-node-v${VERSION}-linux-${ARCH}.zip"
            cp "$NODE_FILE" "$NODE_NEW"
            echo "node_file=$NODE_NEW" >> $GITHUB_OUTPUT
          fi

          # Lingapi - 重命名为标准格式
          if ls Lingapi-master/dist/*.zip 1> /dev/null 2>&1; then
            API_FILE=$(ls Lingapi-master/dist/*.zip | head -1)
            API_NEW="dist/ling-api-v${VERSION}-linux-${ARCH}.zip"
            cp "$API_FILE" "$API_NEW"
            echo "api_file=$API_NEW" >> $GITHUB_OUTPUT
          fi

          # Lingadmin - 重命名为标准格式
          if ls Lingadmin-master/dist/*.zip 1> /dev/null 2>&1; then
            ADMIN_FILE=$(ls Lingadmin-master/dist/*.zip | head -1)
            ADMIN_NEW="dist/ling-admin-v${VERSION}-linux-${ARCH}.zip"
            cp "$ADMIN_FILE" "$ADMIN_NEW"
            echo "admin_file=$ADMIN_NEW" >> $GITHUB_OUTPUT
          fi

          echo "=== Renamed files ==="
          ls -la dist/

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-linux-${{ matrix.arch }}
          path: dist/*.zip
          if-no-files-found: warn

  release:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List downloaded artifacts
        run: |
          echo "=== All artifacts ==="
          find artifacts -type f -name "*.zip" | sort

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/**/*.zip
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 上传到下载站
      - name: Upload to Download Server
        env:
          DL_CI_KEY: ${{ secrets.DL_CI_KEY }}
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}

          echo "=== Uploading to download server ==="
          echo "Version: $VERSION"

          # 检查 CI Key 是否配置
          if [ -z "$DL_CI_KEY" ]; then
            echo "WARNING: DL_CI_KEY secret not configured, skipping upload"
            exit 0
          fi

          # 遍历所有 zip 文件并上传
          for file in $(find artifacts -type f -name "*.zip" | sort); do
            filename=$(basename "$file")
            echo "Processing: $filename"

            # 解析组件类型和架构
            # 文件名格式: ling-{component}-v{version}-linux-{arch}.zip
            if [[ "$filename" =~ ling-([a-z]+)-v[0-9.]+-linux-(amd64|arm64)\.zip ]]; then
              component="${BASH_REMATCH[1]}"
              arch="${BASH_REMATCH[2]}"

              echo "  Component: $component"
              echo "  Arch: $arch"
              echo "  Uploading to: ${{ env.DL_SERVER_URL }}/api/ci/upload.php"

              # 上传文件到下载站 CI 接口
              response=$(curl -s -w "\n%{http_code}" \
                --max-time 300 \
                -X POST \
                -H "X-CI-Key: ${DL_CI_KEY}" \
                -F "file=@${file}" \
                -F "component=${component}" \
                -F "arch=${arch}" \
                -F "changelog=GitHub Actions 自动发布 v${VERSION}" \
                "${{ env.DL_SERVER_URL }}/api/ci/upload.php")

              http_code=$(echo "$response" | tail -1)
              body=$(echo "$response" | sed '$d')

              echo "  HTTP Status: $http_code"
              echo "  Response: $body"

              if [ "$http_code" != "200" ]; then
                echo "  ERROR: Upload failed!"
                # 不退出，继续上传其他文件
              else
                echo "  SUCCESS: File uploaded"
              fi

              echo ""
            else
              echo "  Skipping: filename doesn't match expected pattern"
            fi
          done

          echo "=== Upload complete ==="
